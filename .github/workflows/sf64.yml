name: Build Star Fox 64 for Dreamcast (Final)

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    # MUDANÇA CRÍTICA: Usando a imagem 'standard' da comunidade Dreamcast (Kazade SDK)
    # As imagens 'kallistiose' ou 'kallistios' no GHCR não estão publicamente acessíveis.
    container: kazade/dreamcast-sdk:latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install System Dependencies
        run: |
          # A imagem kazade é baseada em Debian/Ubuntu, então apt-get funciona.
          # genisoimage e build-essential já costumam vir, mas garantimos aqui.
          apt-get update
          apt-get install -y \
            python3 python3-pip python3-venv \
            cmake genisoimage \
            libpng-dev libjpeg-dev \
            git build-essential

      - name: Install Python Dependencies
        run: |
          # Instala dependências Python necessárias para os scripts de assets
          python3 -m pip install -r ./tools/requirements-python.txt --break-system-packages

      - name: Install mkdcdisc (Required for CDI)
        run: |
          # Compila e instala mkdcdisc (necessário para gerar o .cdi final)
          git clone https://gitlab.com/simulant/mkdcdisc.git
          cd mkdcdisc
          mkdir build && cd build
          cmake ..
          make
          make install

      - name: Verify ROM exists
        run: |
          if [ -f "baserom.us.rev1.z64" ]; then
            echo "✅ ROM encontrada: baserom.us.rev1.z64"
            ls -lh baserom.us.rev1.z64
            sha1sum baserom.us.rev1.z64
          else
            echo "❌ ERRO CRÍTICO: O arquivo baserom.us.rev1.z64 não está na raiz!"
            exit 1
          fi

      - name: Configure KOS Environment (Optimize)
        run: |
          # O caminho padrão nessa imagem também é /opt/toolchains/dc/kos
          ENV_FILE="/opt/toolchains/dc/kos/environ.sh"
          
          echo "Aplicando otimizações..."
          
          # Garante permissão de escrita no arquivo de ambiente (caso o container trave root)
          chmod +w $ENV_FILE || true
          
          # Altera -O2 para -O3
          sed -i 's/-O2/-O3/g' $ENV_FILE
          
          # Adiciona flags de LTO se não existirem
          if ! grep -q "ffat-lto-objects" "$ENV_FILE"; then
             sed -i 's/-flto=auto/-flto=auto -ffat-lto-objects/g' $ENV_FILE || true
          fi
          
          echo "Ambiente configurado."

      - name: Build N64 Tools
        run: |
          . /opt/toolchains/dc/kos/environ.sh
          cd tools
          # Força compatibilidade com CMake mais novo se necessário
          CMAKE_POLICY_VERSION_MINIMUM=3.5 make

      - name: Extract Assets (Make Init)
        run: |
          . /opt/toolchains/dc/kos/environ.sh
          make init

      - name: Build Dreamcast CDI
        run: |
          . /opt/toolchains/dc/kos/environ.sh
          make cdi-cdr

      - name: Upload CDI Artifact
        uses: actions/upload-artifact@v4
        with:
          name: SF64-Dreamcast-CDI
          path: |
            *.cdi
          if-no-files-found: error