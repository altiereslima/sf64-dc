name: Build Star Fox 64 for Dreamcast (Final)

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    # Imagem baseada em Fedora 37 com GCC 14 e KOS moderno
    container: kazade/dreamcast-sdk:latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Configure Git Safe Directory
        run: |
          git config --global --add safe.directory '*'

      - name: Install System Dependencies (Fedora)
        run: |
          dnf install -y \
            python3 python3-pip \
            cmake git make gcc gcc-c++ \
            libpng-devel libjpeg-turbo-devel \
            meson libisofs-devel \
            wget which

      - name: Install Python Dependencies
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install -r ./tools/requirements-python.txt --break-system-packages || python3 -m pip install -r ./tools/requirements-python.txt

      - name: Install mkdcdisc (Required for CDI)
        run: |
          git clone https://gitlab.com/simulant/mkdcdisc.git
          cd mkdcdisc
          meson setup build
          meson compile -C build
          meson install -C build
          ldconfig || true
          which mkdcdisc && echo "‚úÖ mkdcdisc instalado"
          mkdcdisc --help > /dev/null 2>&1 || true

      - name: Verify ROM exists
        run: |
          if [ -f "baserom.us.rev1.z64" ]; then
            echo "‚úÖ ROM encontrada"
            ls -lh baserom.us.rev1.z64
            sha1sum baserom.us.rev1.z64
          else
            echo "‚ùå ERRO CR√çTICO: O arquivo baserom.us.rev1.z64 n√£o est√° na raiz!"
            exit 1
          fi

      - name: Patch Source Code (Fix Compilation Errors)
        run: |
          echo "üîß Aplicando corre√ß√µes no c√≥digo para compatibilidade com KOS moderno..."
          
          # 1. Corrige 'vid_set_enabled' (fun√ß√£o removida no KOS novo)
          # Comenta a linha que chama essa fun√ß√£o
          sed -i 's/vid_set_enabled(0);/\/\/vid_set_enabled(0);/g' src/sys/sys_lib.c
          
          # 2. Corrige 'vmu_pkg_load_icon' (fun√ß√£o removida/alterada)
          sed -i 's/vmu_pkg_load_icon/\/\/vmu_pkg_load_icon/g' src/ultra_reimpl.c
          
          # 3. Corrige Rumble (Purupuru) - A struct mudou, ent√£o desativamos a inicializa√ß√£o
          sed -i 's/\.cont =/\/\/.cont =/g' src/sys/sys_joybus.c
          sed -i 's/\.motor =/\/\/.motor =/g' src/sys/sys_joybus.c
          sed -i 's/\.fpow =/\/\/.fpow =/g' src/sys/sys_joybus.c
          sed -i 's/\.conv =/\/\/.conv =/g' src/sys/sys_joybus.c
          sed -i 's/\.freq =/\/\/.freq =/g' src/sys/sys_joybus.c
          sed -i 's/\.inc =/\/\/.inc =/g' src/sys/sys_joybus.c
          sed -i 's/datas\[i\].packet = rumble.raw;/\/\/datas[i].packet = rumble.raw;/g' src/sys/sys_joybus.c
          
          # 4. Corrige conflito de 'bool' (remove defini√ß√£o manual do jogo para usar a do sistema)
          sed -i 's/#define bool s32/\/\/#define bool s32/g' include/n64sys.h
          sed -i 's/#define bool s32/\/\/#define bool s32/g' include/PR/ultratypes.h

          # 5. Adiciona includes necess√°rios
          sed -i '1i #include <stdbool.h>' src/sys/sys_lib.c
          sed -i '1i #include <stdbool.h>' src/sys/sys_joybus.c
          sed -i '1i #include <stdbool.h>' src/sys/sys_fault.c

          echo "‚úÖ Patches aplicados."

      - name: Configure KOS Environment
        run: |
          ENV_FILE="/opt/toolchains/dc/kos/environ.sh"
          chmod +w $ENV_FILE || true
          
          sed -i 's/-O2/-O3/g' $ENV_FILE
          
          # For√ßa padr√£o GNU17 para evitar erros estritos do GCC 14
          echo 'export KOS_CFLAGS="$KOS_CFLAGS -std=gnu17"' >> $ENV_FILE
          
          if ! grep -q "ffat-lto-objects" "$ENV_FILE"; then
             sed -i 's/-flto=auto/-flto=auto -ffat-lto-objects/g' $ENV_FILE || true
          fi

      - name: Build N64 Tools
        run: |
          . /opt/toolchains/dc/kos/environ.sh
          cd tools
          # Compila ferramentas de convers√£o
          CMAKE_POLICY_VERSION_MINIMUM=3.5 make

      - name: Extract Assets (Make Init)
        run: |
          . /opt/toolchains/dc/kos/environ.sh
          git config --global --add safe.directory '*'
          # Extrai texturas e modelos da ROM
          make init

      - name: Build Dreamcast CDI
        run: |
          . /opt/toolchains/dc/kos/environ.sh
          # Compila o bin√°rio final e cria a imagem de disco
          make cdi-cdr

      - name: Upload CDI Artifact
        uses: actions/upload-artifact@v4
        with:
          name: SF64-Dreamcast-CDI
          path: |
            *.cdi
          if-no-files-found: error